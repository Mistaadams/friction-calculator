<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Friction Calc">
    <link rel="manifest" href="manifest.json">
    <title>Friction Calculator - 3D Wellbore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 20px;
        }
        
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-header h1 {
            font-size: 1.4em;
            color: #2c3e50;
        }
        
        .app-header .subtitle {
            font-size: 0.7em;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        .install-prompt {
            background: #ffc107;
            color: #000;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            cursor: pointer;
        }
        
        .install-prompt.show {
            display: block;
        }
        
        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: white;
            color: #7f8c8d;
            font-weight: 600;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .value-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* 3D Wellbore Canvas */
        .wellbore-3d-container {
            position: relative;
            width: 100%;
            height: 450px;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .wellbore-canvas-3d {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }
        
        .wellbore-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.75em;
        }
        
        .pressure-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 0.8em;
        }
        
        .legend-gradient {
            width: 120px;
            height: 20px;
            background: linear-gradient(to right, 
                rgb(0, 0, 255),
                rgb(0, 255, 255),
                rgb(0, 255, 0),
                rgb(255, 255, 0),
                rgb(255, 165, 0),
                rgb(255, 0, 0));
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
        }
        
        .segment-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 0.75em;
            max-width: 150px;
        }
        
        .pressure-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        
        .pressure-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .pressure-card.hydro {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .pressure-card.friction {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }
        
        .pressure-card.formation {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .pressure-card.total {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            grid-column: 1 / -1;
        }
        
        .pressure-card h3 {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .pressure-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .pressure-card .unit {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .result-item h4 {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .result-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .result-item .unit {
            font-size: 0.8em;
            color: #95a5a6;
        }
        
        .flow-regime {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
        }
        
        .regime-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 8px;
        }
        
        .regime-badge.laminar {
            background: #d4edda;
            color: #155724;
        }
        
        .regime-badge.turbulent {
            background: #f8d7da;
            color: #721c24;
        }
        
        .quick-presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preset-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .preset-button:active {
            transform: scale(0.95);
        }
        
        .info-section {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .info-section h3 {
            color: #1976d2;
            font-size: 1em;
            margin-bottom: 8px;
        }
        
        .info-section p {
            color: #424242;
            font-size: 0.85em;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="install-prompt" id="installPrompt">
        Tap here to install as an app
    </div>
    
    <div class="app-header">
        <h1>3D Friction Calculator</h1>
        <div class="subtitle">Delaware Basin - Pressure Heat Map</div>
    </div>
    
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('inputs')">Inputs</button>
            <button class="tab-button" onclick="switchTab('wellbore')">3D View</button>
            <button class="tab-button" onclick="switchTab('results')">Results</button>
            <button class="tab-button" onclick="switchTab('info')">Info</button>
        </div>
        
        <!-- Inputs Tab -->
        <div id="inputsTab" class="tab-content active">
            <div class="card">
                <h2>Well Configuration</h2>
                
                <div class="control-group">
                    <label>
                        True Vertical Depth
                        <span class="value-badge" id="tvdDisplay">9,500 ft</span>
                    </label>
                    <input type="range" id="tvd" min="5000" max="15000" value="9500" step="100">
                </div>
                
                <div class="control-group">
                    <label>
                        Lateral Length
                        <span class="value-badge" id="lateralDisplay">10,000 ft</span>
                    </label>
                    <input type="range" id="lateral" min="5000" max="15000" value="10000" step="100">
                </div>
                
                <div class="control-group">
                    <label>
                        Tubing Diameter
                        <span class="value-badge" id="diameterDisplay">4.50 in</span>
                    </label>
                    <input type="range" id="diameter" min="2.0" max="5.5" value="4.5" step="0.25">
                </div>
            </div>
            
            <div class="card">
                <h2>Fluid Properties</h2>
                
                <div class="control-group">
                    <label>
                        Pump Rate
                        <span class="value-badge" id="rateDisplay">95 BPM</span>
                    </label>
                    <input type="range" id="rate" min="20" max="120" value="95" step="5">
                </div>
                
                <div class="control-group">
                    <label>
                        Fluid Density
                        <span class="value-badge" id="densityDisplay">8.34 ppg</span>
                    </label>
                    <input type="range" id="density" min="8.0" max="10.0" value="8.34" step="0.1">
                </div>
                
                <div class="control-group">
                    <label>
                        Sand Concentration
                        <span class="value-badge" id="sandDisplay">1.50 ppg</span>
                    </label>
                    <input type="range" id="sand" min="0" max="3" value="1.5" step="0.25">
                </div>
                
                <div class="control-group">
                    <label>
                        Friction Reducer
                        <span class="value-badge" id="frDisplay">65%</span>
                    </label>
                    <input type="range" id="frictionReducer" min="0" max="70" value="65" step="5">
                </div>
            </div>
            
            <div class="card">
                <h2>Formation</h2>
                
                <div class="control-group">
                    <label>
                        ISIP (Formation Pressure)
                        <span class="value-badge" id="isipDisplay">7,200 psi</span>
                    </label>
                    <input type="range" id="isip" min="3000" max="10000" value="7200" step="100">
                </div>
            </div>
            
            <div class="card">
                <h2>Delaware Basin Presets</h2>
                <div class="quick-presets">
                    <button class="preset-button" onclick="loadPreset('wolfcamp')">Wolfcamp A</button>
                    <button class="preset-button" onclick="loadPreset('bone')">Bone Spring</button>
                    <button class="preset-button" onclick="loadPreset('avalon')">Avalon Shale</button>
                    <button class="preset-button" onclick="loadPreset('highrate')">High Rate</button>
                </div>
            </div>
        </div>
        
        <!-- 3D Wellbore Tab -->
        <div id="wellboreTab" class="tab-content">
            <div class="card">
                <h2>3D Wellbore - Pressure Heat Map</h2>
                
                <div class="info-section">
                    <p style="margin: 0;">
                        <strong>Swipe or drag</strong> to rotate the 3D view. Each colored segment shows the predicted pressure at that location along the wellbore.
                    </p>
                </div>
                
                <div class="wellbore-3d-container">
                    <canvas id="wellboreCanvas3D" class="wellbore-canvas-3d"></canvas>
                    
                    <div class="wellbore-controls">
                        <strong>Controls:</strong><br>
                        Drag to rotate<br>
                        Pinch to zoom
                    </div>
                    
                    <div class="segment-info" id="segmentInfo">
                        <strong>Wellbore Info</strong><br>
                        Segments: <span id="segmentCount">100</span><br>
                        Max Pressure: <span id="maxPressure">12,557</span> psi
                    </div>
                    
                    <div class="pressure-legend">
                        <strong>Pressure Scale</strong>
                        <div class="legend-gradient"></div>
                        <div class="legend-labels">
                            <span id="legendMin">4,000</span>
                            <span id="legendMax">12,500</span>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            Blue=Low | Red=High
                        </div>
                    </div>
                </div>
                
                <div class="info-section" style="margin-top: 15px;">
                    <h3>Understanding the 3D View</h3>
                    <p>
                        The wellbore is divided into <strong>100 segments</strong>. Each segment is colored based on the predicted pressure:<br><br>
                        <strong>Blue segments</strong> = Lower pressure (formation + hydrostatic)<br>
                        <strong>Green/Yellow</strong> = Medium pressure (friction building)<br>
                        <strong>Orange/Red</strong> = High pressure (near surface)
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Results Tab -->
        <div id="resultsTab" class="tab-content">
            <div class="card">
                <h2>Pressure Breakdown</h2>
                
                <div class="pressure-display">
                    <div class="pressure-card hydro">
                        <h3>Hydrostatic</h3>
                        <div class="value" id="hydroValue">4,117</div>
                        <div class="unit">psi</div>
                    </div>
                    
                    <div class="pressure-card friction">
                        <h3>Friction</h3>
                        <div class="value" id="frictionValue">1,240</div>
                        <div class="unit">psi</div>
                    </div>
                    
                    <div class="pressure-card formation">
                        <h3>Formation</h3>
                        <div class="value" id="formationValue">7,200</div>
                        <div class="unit">psi</div>
                    </div>
                    
                    <div class="pressure-card total">
                        <h3>Total Surface Pressure</h3>
                        <div class="value" id="totalValue">12,557</div>
                        <div class="unit">psi</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Flow Analysis</h2>
                
                <div class="flow-regime">
                    <div style="font-weight: 600; color: #2c3e50;">Flow Regime</div>
                    <div class="regime-badge turbulent" id="regimeBadge">TURBULENT</div>
                    <div style="margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                        Reynolds: <strong id="reynoldsValue">523,847</strong>
                    </div>
                </div>
                
                <div class="results-grid">
                    <div class="result-item">
                        <h4>Velocity</h4>
                        <div class="value" id="velocityValue">6.0</div>
                        <div class="unit">ft/s</div>
                    </div>
                    
                    <div class="result-item">
                        <h4>Friction Factor</h4>
                        <div class="value" id="frictionFactorValue">0.0057</div>
                        <div class="unit">f</div>
                    </div>
                    
                    <div class="result-item">
                        <h4>Measured Depth</h4>
                        <div class="value" id="mdValue">19,500</div>
                        <div class="unit">ft</div>
                    </div>
                    
                    <div class="result-item">
                        <h4>Hydraulic HP</h4>
                        <div class="value" id="hhpValue">2,923</div>
                        <div class="unit">HHP</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Info Tab -->
        <div id="infoTab" class="tab-content">
            <div class="card">
                <h2>Delaware Basin Values</h2>
                
                <div class="info-section">
                    <h3>Wolfcamp Formation</h3>
                    <p>
                        TVD: 8,500-11,000 ft | Lateral: 7,500-12,000 ft<br>
                        ISIP: 6,500-8,000 psi | Rate: 80-110 BPM
                    </p>
                </div>
                
                <div class="info-section">
                    <h3>Bone Spring</h3>
                    <p>
                        TVD: 7,000-9,500 ft | Lateral: 8,000-11,000 ft<br>
                        ISIP: 5,500-7,500 psi | Rate: 85-105 BPM
                    </p>
                </div>
                
                <div class="info-section">
                    <h3>Avalon Shale</h3>
                    <p>
                        TVD: 9,500-12,000 ft | Lateral: 7,000-10,000 ft<br>
                        ISIP: 7,000-8,500 psi | Rate: 75-100 BPM
                    </p>
                </div>
            </div>
            
            <div class="card">
                <h2>About the 3D Visualization</h2>
                
                <div class="info-section">
                    <h3>Discretization</h3>
                    <p>
                        The wellbore is divided into 100 segments. Each segment's pressure is calculated based on:
                        <br>• Distance from surface
                        <br>• Accumulated friction
                        <br>• Hydrostatic pressure
                        <br>• Formation pressure
                    </p>
                </div>
                
                <div class="info-section">
                    <h3>Color Mapping</h3>
                    <p>
                        Colors represent pressure magnitude using a heat map:
                        <br>• Blue (0-25%): Low pressure
                        <br>• Cyan (25-40%): Below average
                        <br>• Green (40-55%): Average
                        <br>• Yellow (55-70%): Above average
                        <br>• Orange (70-85%): High
                        <br>• Red (85-100%): Maximum pressure
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        
        // Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });
        
        document.getElementById('installPrompt').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
            }
        });
        
        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'wellbore') {
                setTimeout(draw3DWellbore, 100);
            }
        }
        
        // Inputs
        const inputs = {
            rate: document.getElementById('rate'),
            tvd: document.getElementById('tvd'),
            lateral: document.getElementById('lateral'),
            sand: document.getElementById('sand'),
            density: document.getElementById('density'),
            diameter: document.getElementById('diameter'),
            frictionReducer: document.getElementById('frictionReducer'),
            isip: document.getElementById('isip')
        };
        
        // Event listeners
        Object.values(inputs).forEach(input => {
            input.addEventListener('input', () => {
                updateDisplays();
                calculate();
                draw3DWellbore();
            });
        });
        
        function updateDisplays() {
            document.getElementById('rateDisplay').textContent = inputs.rate.value + ' BPM';
            document.getElementById('tvdDisplay').textContent = parseInt(inputs.tvd.value).toLocaleString() + ' ft';
            document.getElementById('lateralDisplay').textContent = parseInt(inputs.lateral.value).toLocaleString() + ' ft';
            document.getElementById('sandDisplay').textContent = parseFloat(inputs.sand.value).toFixed(2) + ' ppg';
            document.getElementById('densityDisplay').textContent = parseFloat(inputs.density.value).toFixed(2) + ' ppg';
            document.getElementById('diameterDisplay').textContent = parseFloat(inputs.diameter.value).toFixed(2) + ' in';
            document.getElementById('frDisplay').textContent = inputs.frictionReducer.value + '%';
            document.getElementById('isipDisplay').textContent = parseInt(inputs.isip.value).toLocaleString() + ' psi';
        }
        
        let calculatedPressures = [];
        
        function calculate() {
            const rate = parseFloat(inputs.rate.value);
            const tvd = parseFloat(inputs.tvd.value);
            const lateral = parseFloat(inputs.lateral.value);
            const sand = parseFloat(inputs.sand.value);
            const density = parseFloat(inputs.density.value);
            const diameter = parseFloat(inputs.diameter.value);
            const frEfficiency = parseFloat(inputs.frictionReducer.value) / 100;
            const isip = parseFloat(inputs.isip.value);
            
            const md = tvd + lateral;
            
            // Calculations
            const hydrostatic = 0.052 * density * tvd;
            const area = Math.PI * Math.pow(diameter / 2, 2);
            const velocity = rate / (2.448 * area);
            const viscosity = 1.0;
            const reynolds = (928 * density * velocity * diameter) / viscosity;
            
            let regime = 'TURBULENT';
            let regimeClass = 'turbulent';
            if (reynolds < 2300) {
                regime = 'LAMINAR';
                regimeClass = 'laminar';
            }
            
            let frictionFactor;
            if (reynolds < 2300) {
                frictionFactor = 64 / reynolds;
            } else {
                const roughness = 0.0018;
                frictionFactor = 0.25 / Math.pow(Math.log10(roughness/3.7 + 5.74/Math.pow(reynolds, 0.9)), 2);
            }
            
            const densityLbFt3 = density * 7.48;
            const diameterFt = diameter / 12;
            let frictionPressure = (frictionFactor * md * densityLbFt3 * Math.pow(velocity, 2)) / (2 * diameterFt * 144);
            
            const sandFactor = 1 + (sand * 0.15);
            frictionPressure *= sandFactor;
            frictionPressure *= (1 - frEfficiency);
            
            const totalPressure = hydrostatic + frictionPressure + isip;
            const hhp = (totalPressure * rate) / 40.8;
            
            // Calculate pressure for each segment
            const numSegments = 100;
            calculatedPressures = [];
            
            for (let i = 0; i <= numSegments; i++) {
                const segmentDistance = (md / numSegments) * i;
                let segmentPressure = isip; // Start with formation pressure
                
                // Add hydrostatic for vertical portion
                if (segmentDistance <= tvd) {
                    segmentPressure += 0.052 * density * segmentDistance;
                } else {
                    segmentPressure += hydrostatic;
                }
                
                // Add friction based on distance
                const frictionAtSegment = (frictionPressure / md) * segmentDistance;
                segmentPressure += frictionAtSegment;
                
                calculatedPressures.push(segmentPressure);
            }
            
            // Update displays
            document.getElementById('hydroValue').textContent = Math.round(hydrostatic).toLocaleString();
            document.getElementById('frictionValue').textContent = Math.round(frictionPressure).toLocaleString();
            document.getElementById('formationValue').textContent = Math.round(isip).toLocaleString();
            document.getElementById('totalValue').textContent = Math.round(totalPressure).toLocaleString();
            
            document.getElementById('velocityValue').textContent = velocity.toFixed(1);
            document.getElementById('frictionFactorValue').textContent = frictionFactor.toFixed(4);
            document.getElementById('mdValue').textContent = Math.round(md).toLocaleString();
            document.getElementById('hhpValue').textContent = Math.round(hhp).toLocaleString();
            document.getElementById('reynoldsValue').textContent = Math.round(reynolds).toLocaleString();
            
            const regimeBadge = document.getElementById('regimeBadge');
            regimeBadge.textContent = regime;
            regimeBadge.className = 'regime-badge ' + regimeClass;
            
            // Update legend
            const minPressure = Math.min(...calculatedPressures);
            const maxPressure = Math.max(...calculatedPressures);
            document.getElementById('legendMin').textContent = Math.round(minPressure).toLocaleString();
            document.getElementById('legendMax').textContent = Math.round(maxPressure).toLocaleString();
            document.getElementById('maxPressure').textContent = Math.round(maxPressure).toLocaleString();
        }
        
        // 3D Wellbore Visualization
        let rotationX = 20;
        let rotationY = 45;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        function draw3DWellbore() {
            const canvas = document.getElementById('wellboreCanvas3D');
            if (!canvas || !canvas.getContext) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const tvd = parseFloat(inputs.tvd.value);
            const lateral = parseFloat(inputs.lateral.value);
            
            if (calculatedPressures.length === 0) {
                calculate();
            }
            
            const minPressure = Math.min(...calculatedPressures);
            const maxPressure = Math.max(...calculatedPressures);
            
            // Draw 3D wellbore with 100 segments
            const numSegments = 100;
            const segmentLengthVertical = tvd / (numSegments * 0.5); // Half segments for vertical
            const segmentLengthHorizontal = lateral / (numSegments * 0.5); // Half segments for horizontal
            
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = Math.min(width, height) / 25;
            
            // Draw vertical section (50 segments)
            for (let i = 0; i < numSegments / 2; i++) {
                const depth = i * segmentLengthVertical;
                const pressure = calculatedPressures[i * 2];
                const color = getPressureColor(pressure, minPressure, maxPressure);
                
                // 3D projection
                const x1 = 0;
                const y1 = -depth / 100;
                const z1 = 0;
                
                const x2 = 0;
                const y2 = -(depth + segmentLengthVertical) / 100;
                const z2 = 0;
                
                const proj1 = project3D(x1, y1, z1, rotationX, rotationY, centerX, centerY, scale);
                const proj2 = project3D(x2, y2, z2, rotationX, rotationY, centerX, centerY, scale);
                
                // Draw segment as cylinder
                drawCylinderSegment(ctx, proj1.x, proj1.y, proj2.x, proj2.y, 8, color, proj1.depth);
            }
            
            // Draw horizontal section (50 segments)
            for (let i = 0; i < numSegments / 2; i++) {
                const distance = i * segmentLengthHorizontal;
                const pressure = calculatedPressures[50 + i * 2];
                const color = getPressureColor(pressure, minPressure, maxPressure);
                
                // 3D projection
                const x1 = distance / 100;
                const y1 = -tvd / 100;
                const z1 = 0;
                
                const x2 = (distance + segmentLengthHorizontal) / 100;
                const y2 = -tvd / 100;
                const z2 = 0;
                
                const proj1 = project3D(x1, y1, z1, rotationX, rotationY, centerX, centerY, scale);
                const proj2 = project3D(x2, y2, z2, rotationX, rotationY, centerX, centerY, scale);
                
                // Draw segment as cylinder
                drawCylinderSegment(ctx, proj1.x, proj1.y, proj2.x, proj2.y, 8, color, proj1.depth);
            }
            
            // Draw surface marker
            const surfaceProj = project3D(0, 0, 0, rotationX, rotationY, centerX, centerY, scale);
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(surfaceProj.x, surfaceProj.y, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw toe marker
            const toeProj = project3D(lateral / 100, -tvd / 100, 0, rotationX, rotationY, centerX, centerY, scale);
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(toeProj.x, toeProj.y, 6, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function project3D(x, y, z, rotX, rotY, centerX, centerY, scale) {
            // Rotate around X axis
            const radX = rotX * Math.PI / 180;
            const y1 = y * Math.cos(radX) - z * Math.sin(radX);
            const z1 = y * Math.sin(radX) + z * Math.cos(radX);
            
            // Rotate around Y axis
            const radY = rotY * Math.PI / 180;
            const x1 = x * Math.cos(radY) + z1 * Math.sin(radY);
            const z2 = -x * Math.sin(radY) + z1 * Math.cos(radY);
            
            // Project to 2D
            const perspective = 1 / (1 + z2 * 0.1);
            
            return {
                x: centerX + x1 * scale * perspective,
                y: centerY + y1 * scale * perspective,
                depth: z2
            };
        }
        
        function drawCylinderSegment(ctx, x1, y1, x2, y2, radius, color, depth) {
            ctx.strokeStyle = color;
            ctx.lineWidth = radius * (1 + depth * 0.1);
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }
        
        function getPressureColor(pressure, minPressure, maxPressure) {
            const fraction = (pressure - minPressure) / (maxPressure - minPressure);
            
            let r, g, b;
            if (fraction < 0.17) {
                // Blue to Cyan
                const t = fraction / 0.17;
                r = Math.round(0 * (1 - t) + 0 * t);
                g = Math.round(0 * (1 - t) + 255 * t);
                b = Math.round(255);
            } else if (fraction < 0.33) {
                // Cyan to Green
                const t = (fraction - 0.17) / 0.17;
                r = 0;
                g = 255;
                b = Math.round(255 * (1 - t) + 0 * t);
            } else if (fraction < 0.5) {
                // Green to Yellow
                const t = (fraction - 0.33) / 0.17;
                r = Math.round(0 * (1 - t) + 255 * t);
                g = 255;
                b = 0;
            } else if (fraction < 0.67) {
                // Yellow to Orange
                const t = (fraction - 0.5) / 0.17;
                r = 255;
                g = Math.round(255 * (1 - t) + 165 * t);
                b = 0;
            } else {
                // Orange to Red
                const t = (fraction - 0.67) / 0.33;
                r = 255;
                g = Math.round(165 * (1 - t) + 0 * t);
                b = 0;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // Mouse/Touch controls for 3D rotation
        const canvas = document.getElementById('wellboreCanvas3D');
        
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                
                rotationY += deltaX * 0.5;
                rotationX += deltaY * 0.5;
                
                // Limit rotation
                rotationX = Math.max(-90, Math.min(90, rotationX));
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                
                draw3DWellbore();
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
        });
        
        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isDragging = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault();
                const deltaX = e.touches[0].clientX - lastMouseX;
                const deltaY = e.touches[0].clientY - lastMouseY;
                
                rotationY += deltaX * 0.5;
                rotationX += deltaY * 0.5;
                
                rotationX = Math.max(-90, Math.min(90, rotationX));
                
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
                
                draw3DWellbore();
            }
        });
        
        canvas.addEventListener('touchend', () => {
            isDragging = false;
        });
        
        function loadPreset(type) {
            switch(type) {
                case 'wolfcamp':
                    inputs.tvd.value = 9500;
                    inputs.lateral.value = 10000;
                    inputs.rate.value = 95;
                    inputs.sand.value = 1.5;
                    inputs.isip.value = 7200;
                    inputs.diameter.value = 4.5;
                    inputs.frictionReducer.value = 65;
                    break;
                case 'bone':
                    inputs.tvd.value = 8000;
                    inputs.lateral.value = 9500;
                    inputs.rate.value = 90;
                    inputs.sand.value = 1.75;
                    inputs.isip.value = 6500;
                    inputs.diameter.value = 4.5;
                    inputs.frictionReducer.value = 65;
                    break;
                case 'avalon':
                    inputs.tvd.value = 10500;
                    inputs.lateral.value = 8500;
                    inputs.rate.value = 85;
                    inputs.sand.value = 1.25;
                    inputs.isip.value = 7800;
                    inputs.diameter.value = 4.5;
                    inputs.frictionReducer.value = 60;
                    break;
                case 'highrate':
                    inputs.rate.value = 110;
                    inputs.sand.value = 2.0;
                    inputs.frictionReducer.value = 70;
                    break;
            }
            updateDisplays();
            calculate();
            draw3DWellbore();
        }
        
        // Initial setup
        updateDisplays();
        calculate();
        setTimeout(() => {
            draw3DWellbore();
        }, 500);
    </script>
</body>
</html>
